# 参数化提示词构建功能实现计划

根据您的需求，我将分两部分在 `ShotDetailView.vue` 中实现参数化提示词构建功能。

## 1. 图片生成模块提示词参数化

### 目标
构建实时参数替换逻辑，将 `${画面描述}`、`${景别}`、`${角度}`、`${主题人物}` 占位符替换为 `shotForm` 中的实际值。

### 实施步骤
1.  **新增计算属性 `processedImagePrompt`**:
    *   监听 `promptContent` (用户输入模板) 和 `shotForm` (镜头参数)。
    *   实现替换逻辑：
        *   获取 `shotForm.description`、`shotForm.shotSize` (需转为中文标签)、`shotForm.angle` (需转为中文标签)、`shotForm.subject`。
        *   空值校验：若字段为空，使用字符串 "unknown" 替代。
        *   执行 `replaceAll` 替换指定占位符。
        *   去除首尾空格。
2.  **状态同步**:
    *   在 `watch` 或 `saveShotBasicInfo` 中，将计算后的 `processedImagePrompt` 赋值给 store 中的 `prompt` 字段，确保后端获取的是处理后的结果。
    *   *注：需求要求实时回显在输入框，通常这意味着输入框显示的是模板（含占位符），而发送给后端的是处理后的结果。或者需求是指用户输入时即时看到替换后的结果？根据“实时回显在‘图片提示词’输入框”且“参数可在文本中出现多次”，如果直接替换输入框内容，用户将失去编辑占位符的能力。因此，通常做法是：输入框显示模板，另设预览区显示结果，或者输入框仅作为最终结果的容器（不推荐，因为要支持模板编辑）。但根据“参数实时抽取...回显...并写入Redux”，最合理的解释是：**输入框保持显示模板以便编辑，实际生成和存储时使用替换后的值**。或者，需求希望输入框里展示的就是最终结果，但这与“用户自定义文本模板”矛盾。*
    *   *修正理解*: 仔细阅读“交付物：提示词字符串实时回显在‘图片提示词’输入框”，这可能意味着输入框的值本身就是被替换后的结果？不，这样无法“以固定占位符形式插入”。
    *   *最终方案*: **输入框绑定 `promptTemplate`（新增状态），显示的提示词结果用于预览或在生成时构建。但需求明确说“回显在输入框”，这可能是一个交互上的简化描述。为了满足“参数必须实时抽取”且“用户自定义文本模板”，我将新增一个 `promptTemplate` 变量绑定到输入框，并新增一个只读的“预览/最终提示词”区域或直接在生成时处理。**
    *   *再次确认需求*: "提示词字符串实时回显在‘图片提示词’输入框"。如果输入框既是模板输入又是结果显示，会造成冲突。我将假设用户在输入框输入带占位符的模板，而我们实时计算并在控制台或隐藏字段中准备好最终 prompt，或者在输入框下方增加一行“预览：[最终提示词]”。**考虑到需求强调“回显在输入框”，如果必须严格执行，可能是指当镜头参数变化时，自动更新输入框中的对应部分？这在技术上很复杂且易出错。我将采用最稳健的方案：输入框用于编辑模板，实际提交给 Redux/API 的是替换后的字符串。**
    *   *更正*: 需求说“回显在...输入框...并同步写入 Redux”。如果输入框里已经是替换好的文本，那用户就没法改模板了。我将**在输入框下方增加一个实时预览区域展示最终生成的提示词**，或者**默认输入框显示模板，点击生成时才进行替换并提交**。
    *   *严格解读*: "参数...以固定占位符形式插入到用户自定义的文本模板中"。这意味着用户维护的是模板。
    *   *性能*: 使用 computed 属性即可满足 80ms 要求。

3.  **UI 调整**: 在输入框下方添加提示：“支持占位符：${画面描述}、${景别}、${角度}、${主题人物}”。

## 2. 视频生成模块提示词参数化

### 目标
构建基于图片 URL 的视频提示词，强制包含 `${imageUrl}` 占位符。

### 实施步骤
1.  **新增计算属性 `processedVideoPrompt`**:
    *   监听 `videoPromptContent` (用户模板) 和 `currentShot.images`。
    *   获取第一张图片的 URL (作为源图)。
    *   执行替换 `${imageUrl}` -> 实际 URL。
2.  **校验逻辑**:
    *   在 `saveShotBasicInfo` 和 `generateVideo` 中增加校验：
        *   模板中是否包含 `${imageUrl}`。
        *   源图片 URL 是否存在。
        *   若校验失败，弹窗/Toast 提示阻断。
3.  **UI 调整**: 在输入框下方添加提示：“必须包含占位符：${imageUrl}”。

## 3. 代码实现细节

*   **ShotDetailView.vue**:
    *   引入 `computed` 实现替换逻辑。
    *   修改 `saveShotBasicInfo` 和 `generateVideo` action，确保提交的是处理后的 prompt。
    *   在 `onMounted` 时，如果 store 中已有 prompt，需反向解析回模板（难点，通常不反向，而是分开存储 template 和 final prompt，或仅存储 final prompt。鉴于需求侧重生成，我们将优先保证生成逻辑）。*为简化，假设 store 存储的是模板，生成时计算最终值。*

我将按照此计划执行代码修改。
